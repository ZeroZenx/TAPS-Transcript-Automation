// Prisma schema for TAPS - Transcript Automation and Processing Service

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id             String   @id @default(uuid())
  email          String   @unique
  name           String
  role           String   @default("STUDENT") // STUDENT, LIBRARY, BURSAR, ACADEMIC, VERIFIER, PROCESSOR, ADMIN
  passwordHash   String?  // For local authentication
  authMethod     String   @default("AZURE") // AZURE or LOCAL
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  requests       Request[]
  auditLogs      AuditLog[]
  errorLogs      ErrorLog[]
}

model Request {
  id             String   @id @default(uuid())
  title          String?
  requestId      String?  @unique // External request ID
  studentId      String
  studentEmail   String
  contactNumber  String?  // Optional contact number
  program        String
  requestDate    DateTime @default(now())
  status         String   @default("PENDING") // PENDING, IN_REVIEW, APPROVED, REJECTED, COMPLETED, CANCELLED, NEW
  idValue        String?  // Id_Value field
  requestor      String?  // Requestor name
  
  // Academic fields
  academicStatus String?
  academicNote   String?
  academicHistory String?
  academicVerifierComments String?
  academicCorrectionAddressed String? // TRUE/FALSE
  academicCorrectionComments String?
  responsibleDeptForAcademicIssues String?
  academicDeptFirstReminder DateTime?
  academicDeptSecondReminder DateTime?
  academicDeptThirdReminder DateTime?
  academicDeptFourthReminder DateTime?
  
  // Library fields
  libraryStatus  String?
  libraryNote    String?
  libraryDeptDueAmount String?
  libraryDeptDueDetails String?
  bursarsConfirmationForLibraryDuePayment String? // TRUE/FALSE
  
  // Bursar fields
  bursarStatus   String?
  bursarNote     String?
  officeOfBursarDueAmount String?
  officeOfBursarDueDetails String?
  
  // Request details
  gpaRecalculation String?
  changeOfProgramme String?
  addressFormat String?
  honourToBeEntered String?
  degreeToBeAwarded String?
  inProgressCoursesForPriorSemester String?
  transcriptTemplateIssue String?
  other String?
  
  // Financial
  totalDue String?
  
  // Notifications
  sendNotification String? // TRUE/FALSE
  sendAcademicHistoryNotification String? // TRUE/FALSE
  sendAutomaticNotificationForPendingAcademic String? // TRUE/FALSE
  sendAutomaticNotificationForPendingDue String? // TRUE/FALSE
  sendDuePendingNotification String? // TRUE/FALSE
  sendAcademicCorrectionMadeNotification String? // TRUE/FALSE
  sendToTranscriptVerifier String? // TRUE/FALSE
  
  // Notification dates
  assistantRegistrarNotificationDate DateTime?
  deanRegistrarNotificationDate DateTime?
  vpAcademicAffairsAndRegistrarNotificationDate DateTime?
  requestCancellationNotificationDate DateTime?
  pendingDueFirstReminderDate DateTime?
  pendingDueFinalReminderDate DateTime?
  pendingDueRequestCancellationReminder DateTime?
  
  // Cancellation
  cancelType String?
  reasonForRequestCancellation String?
  
  // Messages and conversations
  recentMessage String?
  conversations String?
  sentTo String?
  sendMessage String? // TRUE/FALSE
  
  // Parchment
  parchmentCode String?
  
  // Verifier/Processor
  verifierNotes  String?
  processorNotes String?
  
  // Files
  filesUrl       String?
  
  // Metadata
  created DateTime @default(now())
  createdBy String?
  modified DateTime @updatedAt
  modifiedBy String?
  
  // Relations
  userId         String?
  user           User?          @relation(fields: [userId], references: [id], onDelete: SetNull)
  auditLogs      AuditLog[]
  slaMetrics     SLAMetric[]
}

model AuditLog {
  id        String   @id @default(uuid())
  requestId String?
  request   Request? @relation(fields: [requestId], references: [id], onDelete: Cascade)
  userId    String?
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  action    String
  details   String?
  timestamp DateTime @default(now())

  @@index([requestId])
  @@index([userId])
  @@index([timestamp])
}

model Settings {
  id                    String   @id @default("settings")
  // Office 365 Email Configuration
  emailAccount          String?  // Office 365 email account (e.g., taps@costaatt.edu.tt)
  emailPassword         String?  // Encrypted password or client secret
  tenantId              String?  // Azure AD Tenant ID
  clientId              String?  // Azure AD Application (Client) ID
  clientSecret          String?  // Azure AD Client Secret (encrypted)
  useClientCredentials  Boolean  @default(false) // Use client credentials vs user credentials
  // Email Settings
  fromName              String?  // Display name for emails (e.g., "TAPS System")
  replyTo                String?  // Reply-to email address
  enableAlerts          Boolean  @default(true)  // Enable email alerts
  enableReminders       Boolean  @default(true)   // Enable email reminders
  // Department Email Addresses
  libraryEmail          String?  // Library department email address
  bursarEmail           String?  // Bursar department email address
  academicEmail         String?  // Academic department email address
  // Email Templates
  libraryQueueTemplate  String?  // Email template for Library queue notifications
  libraryQueueSubject   String?  // Email subject for Library queue notifications
  bursarQueueTemplate   String?  // Email template for Bursar queue notifications
  bursarQueueSubject    String?  // Email subject for Bursar queue notifications
  academicQueueTemplate String?  // Email template for Academic queue notifications
  academicQueueSubject  String?  // Email subject for Academic queue notifications
  academicCompletedTemplate String? // Email template when academic verification is completed
  academicCompletedSubject   String? // Email subject when academic verification is completed
  academicCorrectionTemplate String? // Email template when academic corrections are required
  academicCorrectionSubject  String? // Email subject when academic corrections are required
  completionTemplate         String? // Email template when request is 100% completed
  completionSubject          String? // Email subject when request is completed
  cancellationTemplate       String? // Email template when request is cancelled
  cancellationSubject        String? // Email subject when request is cancelled
  // Reminder Settings
  reminderHoursLibrary   Int?     @default(48) // Hours before sending reminder to Library
  reminderHoursBursar    Int?     @default(48) // Hours before sending reminder to Bursar
  reminderHoursAcademic  Int?     @default(48) // Hours before sending reminder to Academic
  enableReminderLibrary  Boolean  @default(true) // Enable reminders for Library
  enableReminderBursar   Boolean  @default(true) // Enable reminders for Bursar
  enableReminderAcademic Boolean  @default(true) // Enable reminders for Academic
  // Timestamps
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

model AnalyticsSnapshot {
  id                    String   @id @default(uuid())
  date                  DateTime @default(now())
  // Department Metrics
  libraryAvgProcessingTime Float?   // Average processing time in hours
  bursarAvgProcessingTime  Float?
  academicAvgProcessingTime Float?
  processorAvgProcessingTime Float?
  // Request Metrics
  totalRequests         Int      @default(0)
  pendingRequests       Int      @default(0)
  completedRequests     Int      @default(0)
  cancelledRequests     Int      @default(0)
  // Volume by Department
  libraryPendingCount   Int      @default(0)
  bursarPendingCount    Int      @default(0)
  academicPendingCount  Int      @default(0)
  processorPendingCount Int      @default(0)
  // Trends
  requestsCreatedToday  Int      @default(0)
  requestsCompletedToday Int     @default(0)
  createdAt             DateTime @default(now())

  @@index([date])
}

model SLAMetric {
  id                    String   @id @default(uuid())
  requestId             String?
  request               Request? @relation(fields: [requestId], references: [id], onDelete: Cascade)
  department            String   // LIBRARY, BURSAR, ACADEMIC, PROCESSOR
  targetHours           Int      // SLA target in hours
  actualHours           Float?   // Actual processing time in hours
  status                String   @default("PENDING") // PENDING, MET, BREACHED, WARNING
  startTime             DateTime
  completedTime         DateTime?
  breached              Boolean  @default(false)
  warningSent           Boolean  @default(false)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([requestId])
  @@index([department])
  @@index([status])
  @@index([startTime])
}

model Backup {
  id                    String   @id @default(uuid())
  filename              String
  filePath              String
  backupType            String   @default("FULL") // FULL, INCREMENTAL
  sizeBytes             Int
  recordCount           Int?     // Number of records backed up
  status                String   @default("PENDING") // PENDING, COMPLETED, FAILED
  startedAt             DateTime @default(now())
  completedAt           DateTime?
  errorMessage          String?
  createdBy             String?
  createdAt             DateTime @default(now())

  @@index([backupType])
  @@index([status])
  @@index([startedAt])
}

model SystemHealth {
  id                    String   @id @default(uuid())
  timestamp             DateTime @default(now())
  // Server Metrics
  cpuUsage              Float?   // CPU usage percentage
  memoryUsage           Float?   // Memory usage percentage
  diskUsage             Float?   // Disk usage percentage
  // Database Metrics
  dbConnectionCount     Int?
  dbQueryTime           Float?   // Average query time in ms
  // Application Metrics
  activeUsers           Int      @default(0)
  requestsPerMinute      Float    @default(0)
  errorCount            Int      @default(0)
  // Response Times
  avgResponseTime       Float?   // Average API response time in ms
  // Status
  status                String   @default("HEALTHY") // HEALTHY, WARNING, CRITICAL
  alerts                String?  // JSON array of active alerts

  @@index([timestamp])
  @@index([status])
}

model ErrorLog {
  id                    String   @id @default(uuid())
  errorType             String   // ERROR, WARNING, CRITICAL
  message               String
  stackTrace            String?
  userId                String?
  user                  User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  requestId             String?
  endpoint              String?
  statusCode            Int?
  resolved              Boolean  @default(false)
  resolvedAt           DateTime?
  resolvedBy            String?
  createdAt             DateTime @default(now())

  @@index([errorType])
  @@index([userId])
  @@index([requestId])
  @@index([resolved])
  @@index([createdAt])
}

model ScheduledReport {
  id                    String   @id @default(uuid())
  name                  String
  reportType            String   // ANALYTICS, PERFORMANCE, COMPLIANCE, CUSTOM
  frequency             String   // DAILY, WEEKLY, MONTHLY
  dayOfWeek             Int?     // 0-6 for weekly (0=Sunday)
  dayOfMonth            Int?     // 1-31 for monthly
  recipients            String   // JSON array of email addresses
  filters               String?  // JSON object with filter criteria
  lastRun               DateTime?
  nextRun               DateTime
  enabled               Boolean  @default(true)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([enabled])
  @@index([nextRun])
}

